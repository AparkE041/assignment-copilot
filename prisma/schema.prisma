// Assignment Copilot - Prisma Schema
// Supabase Postgres + pgvector

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --- Auth (NextAuth) ---
model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  emailVerified      DateTime?
  name               String?
  image              String?
  password           String? // For credentials auth
  hasOnboarded       Boolean   @default(false)
  calendarFeedSecret String?   @unique
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  accounts           Account[]
  sessions           Session[]
  courses            Course[]
  canvasConnection   CanvasConnection?
  aiSettings         AiSettings?
  plannedSessions    PlannedSession[]
  reminderRules      ReminderRule[]
  reminderEvents     ReminderEvent[]
  chatThreads        ChatThread[]
  tutorThreads       TutorThread[]
  availabilityBlocks AvailabilityBlock[]
  syncLogs           SyncLog[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
}

// --- Canvas ---
model CanvasConnection {
  id          String   @id @default(cuid())
  userId      String   @unique
  accessToken String   // Encrypted at rest
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Course {
  id                    String   @id @default(cuid())
  canvasId              String
  userId                String
  name                  String
  currentGrade          String?  // e.g. "A", "89.5%"
  currentScore          Float?   // numeric score
  rawPayload            Json?
  syllabusExtractedText String?  // Extracted from linked PDF/DOCX when syllabus is a file
  syllabusSections      Json?    // AI-categorized sections [{id, title, content}]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments Assignment[]

  @@unique([userId, canvasId])
}

model AiSettings {
  id              String   @id @default(cuid())
  userId          String   @unique
  openRouterKey   String?  // Azure API key (repurposed from OpenRouter/Groq)
  azureEndpoint   String?
  azureDeployment String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Assignment {
  id              String   @id @default(cuid())
  courseId        String
  canvasId        String
  title           String
  descriptionHtml String?
  dueAt           DateTime?
  points          Int?
  grade           String?   // e.g. "85", "A", "complete"
  score           Float?    // numeric score if available
  submissionTypes Json?
  rubric          Json?
  rawPayload      Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  course           Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attachments      Attachment[]
  localState       AssignmentLocalState?
  plannedSessions  PlannedSession[]
  reminderEvents   ReminderEvent[]
  checklistItems   ChecklistItem[]
  chatThreads      ChatThread[]
  embeddingChunks  EmbeddingChunk[]

  @@unique([courseId, canvasId])
}

model Attachment {
  id               String   @id @default(cuid())
  assignmentId     String
  url              String
  filename         String?
  mime             String?
  extractedText    String?
  extractionStatus String   @default("pending") // pending | processing | completed | failed
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  assignment     Assignment      @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  embeddingChunks EmbeddingChunk[]
}

model AssignmentLocalState {
  id                    String   @id @default(cuid())
  assignmentId          String   @unique
  status                String   @default("not_started") // not_started | in_progress | done
  notes                 String?
  estimatedEffortMinutes Int?
  priority              Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

// --- Planning ---
model PlannedSession {
  id           String   @id @default(cuid())
  assignmentId String
  userId       String
  startAt      DateTime
  endAt        DateTime
  completed    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AvailabilityBlock {
  id        String   @id @default(cuid())
  userId    String
  startAt   DateTime
  endAt     DateTime
  source    String   @default("ics") // ics
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- Reminders ---
model ReminderRule {
  id                  String   @id @default(cuid())
  userId              String
  assignmentId        String?
  triggerHoursBefore  Float
  channel             String   @default("email")
  quietStart          Int?     // hour 0-23
  quietEnd            Int?     // hour 0-23
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReminderEvent {
  id           String    @id @default(cuid())
  assignmentId String
  userId       String
  scheduledAt  DateTime
  sentAt       DateTime?
  channel      String    @default("email")
  status       String    @default("pending") // pending | sent | skipped | failed
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- Checklist ---
model ChecklistItem {
  id           String   @id @default(cuid())
  assignmentId String
  title        String
  checked      Boolean  @default(false)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

// --- Chat ---
model ChatThread {
  id           String   @id @default(cuid())
  assignmentId String
  userId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignment Assignment   @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages   ChatMessage[]
}

model ChatMessage {
  id        String   @id @default(cuid())
  threadId  String
  role      String   // user | assistant | system
  content   String
  createdAt DateTime @default(now())

  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

// --- Global AI Tutor (no assignment context) ---
model TutorThread {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages TutorMessage[]
}

model TutorMessage {
  id        String   @id @default(cuid())
  threadId  String
  role      String   // user | assistant | system
  content   String
  createdAt DateTime @default(now())

  thread TutorThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

// --- RAG / Embeddings ---
model EmbeddingChunk {
  id           String   @id @default(cuid())
  assignmentId String
  attachmentId String?
  text         String
  embedding    Unsupported("vector(1536)")?
  createdAt    DateTime @default(now())

  assignment Assignment  @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  attachment Attachment? @relation(fields: [attachmentId], references: [id], onDelete: Cascade)
}

// --- Sync ---
model SyncLog {
  id        String   @id @default(cuid())
  userId    String
  type      String   // canvas_full | canvas_incremental
  status    String   // success | partial | failed
  message   String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
